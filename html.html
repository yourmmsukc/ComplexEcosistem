<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ecosistema Top‑Down en Godot — Estructura data‑driven y demo</title>
<style>
  :root {
    --bg: #0f1115;
    --panel: #151822;
    --panel-2: #1b2030;
    --txt: #e6e9ef;
    --muted: #a9b0c0;
    --accent: #7ab7ff;
    --accent-2: #ffb86c;
    --ok: #91d7a3;
    --warn: #f5c2e7;
    --danger: #f38ba8;
    --code-bg: #0b0d12;
    --border: #262b3a;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--txt);
    background: linear-gradient(180deg, #0d0f14 0%, #0f1115 60%, #0e1014 100%);
  }

  header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(15,17,21,0.8); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
  .title { display: flex; flex-wrap: wrap; align-items: baseline; gap: 12px; }
  .title h1 { margin: 0; font-size: 1.6rem; letter-spacing: .3px; }
  .title p { margin: 0; color: var(--muted); }
  nav { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
  nav a {
    color: var(--txt); text-decoration: none; font-size: .92rem;
    padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px;
    background: var(--panel);
  }
  nav a:hover { border-color: var(--accent); color: var(--accent); }

  section { scroll-margin-top: 80px; }
  .grid {
    display: grid; gap: 16px;
  }
  @media (min-width: 960px) {
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  }

  .panel {
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .panel h2, .panel h3 { margin-top: 0; }
  .badge {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: .78rem; color: var(--muted);
    border: 1px solid var(--border); padding: 2px 8px; border-radius: 100px;
  }
  .badges { display: flex; flex-wrap: wrap; gap: 8px; }

  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background: #0a0c11; border: 1px solid var(--border); padding: 2px 6px; border-radius: 6px; }

  pre, code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: .92rem; line-height: 1.45;
  }
  pre {
    margin: 0; background: var(--code-bg); color: #d1d6e4; border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; position: relative; overflow: auto;
  }
  .codeblock { position: relative; }
  .copy-btn {
    position: absolute; top: 8px; right: 8px; z-index: 1;
    font-size: .8rem; color: var(--txt); background: #161a24;
    border: 1px solid var(--border); border-radius: 8px;
    padding: 4px 8px; cursor: pointer;
  }
  .copy-btn:hover { color: var(--accent); border-color: var(--accent); }

  .diagram {
    background: radial-gradient(1200px 600px at 100% -200px, rgba(122,183,255,0.05), transparent 60%),
                radial-gradient(1200px 600px at -100% 120%, rgba(243,138,168,0.06), transparent 60%),
                var(--panel);
    border: 1px dashed var(--border);
    min-height: 380px; position: relative; border-radius: 12px; overflow: hidden;
  }
  .node {
    position: absolute; min-width: 160px; max-width: 260px;
    background: #121623; border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  }
  .node h4 { margin: 0 0 6px 0; font-size: .95rem; color: var(--accent); }
  .node p { margin: 0; font-size: .85rem; color: var(--muted); }
  .line { position: absolute; pointer-events: none; }
  svg { position: absolute; inset: 0; }

  .list { padding-left: 18px; }
  .list li { margin: 6px 0; }

  .pill {
    display: inline-block; font-size: .78rem; padding: 2px 8px; border-radius: 999px;
    border: 1px solid var(--border); background: #121623; color: var(--muted); margin-right: 6px;
  }

  .toggle {
    display: inline-flex; align-items: center; gap: 10px; padding: 6px 10px; border-radius: 8px;
    background: var(--panel); border: 1px solid var(--border); cursor: pointer;
  }
  .small { font-size: .9rem; color: var(--muted); }

  footer { color: var(--muted); text-align: center; padding: 30px 10px; }

  /* Interactive demo */
  .form { display: grid; gap: 10px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  label { font-size: .9rem; color: var(--muted); }
  input[type="text"], input[type="number"] {
    width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border);
    background: #0f1320; color: var(--txt);
  }
  .checkboxes { display: flex; flex-wrap: wrap; gap: 10px; }
  .btn {
    background: #162037; border: 1px solid var(--border); color: var(--txt);
    padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .out {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono";
    white-space: pre; background: var(--code-bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; min-height: 120px;
  }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="title">
      <h1>Ecosistema Top‑Down en Godot</h1>
      <p>Data‑driven • Composición • Variantes derivadas (overlays)</p>
    </div>
    <nav>
      <a href="#objetivo">Objetivo</a>
      <a href="#estructura-visual">Estructura visual</a>
      <a href="#modelos">Modelos de datos</a>
      <a href="#flujo">Flujo de trabajo</a>
      <a href="#demo">Demo: derivar especie</a>
      <a href="#componentes">Componentes y AI</a>
      <a href="#proyecto">Estructura de proyecto</a>
      <a href="#rendimiento">Rendimiento</a>
    </nav>
  </div>
</header>

<main class="container" style="padding-bottom: 60px;">

  <section id="objetivo" class="panel">
    <h2>Objetivo</h2>
    <p>Una estructura clara para crear especies rápido (vida, hambre, velocidad, mordida), añadir dieta y habilidades después, y derivar nuevas especies (variantes/evolución) sin duplicar código.</p>
    <div class="badges">
      <span class="badge">Resources .tres</span>
      <span class="badge">Composición con Traits</span>
      <span class="badge">Overlays para variantes</span>
      <span class="badge">Factory para construir especies</span>
    </div>
  </section>

  <section id="estructura-visual" class="panel">
    <h2>Estructura visual del sistema</h2>
    <p class="small">Esquema de relaciones principales (visual y conceptual). Las flechas indican “usa/compone”.</p>
    <div class="diagram" id="diagram">
      <!-- Nodes -->
      <div class="node" style="left:20px; top:30px;">
        <h4>SpeciesResource</h4>
        <p>hp, speed, bite_power, hunger...</p>
      </div>
      <div class="node" style="left:330px; top:20px;">
        <h4>TraitResource</h4>
        <p>add/mul stats, +diet, +tags, +abilities</p>
      </div>
      <div class="node" style="left:640px; top:20px;">
        <h4>AbilityResource</h4>
        <p>cooldown, efectos, tags</p>
      </div>
      <div class="node" style="left:640px; top:160px;">
        <h4>EffectResource</h4>
        <p>damage/heal/buff/debuff/state</p>
      </div>
      <div class="node" style="left:330px; top:200px;">
        <h4>SpeciesOverlay</h4>
        <p>base + set/add + traits → derivada</p>
      </div>
      <div class="node" style="left:20px; top:220px;">
        <h4>SpeciesFactory</h4>
        <p>Construye Species a partir de Overlay</p>
      </div>
      <div class="node" style="left:20px; top:360px;">
        <h4>Agent (Node2D)</h4>
        <p>Usa SpeciesResource para stats/AI</p>
      </div>
      <div class="node" style="left:640px; top:310px;">
        <h4>Food/Plant</h4>
        <p>nutrientes, tags, produce foods</p>
      </div>
      <!-- Edges (SVG) -->
      <svg viewBox="0 0 900 450" preserveAspectRatio="none">
        <!-- SpeciesResource -> TraitResource -->
        <path d="M 180 70 C 250 70, 250 70, 330 70" stroke="rgba(122,183,255,0.8)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <!-- TraitResource -> AbilityResource -->
        <path d="M 470 70 C 540 70, 540 70, 640 70" stroke="rgba(122,183,255,0.6)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <!-- AbilityResource -> EffectResource -->
        <path d="M 740 100 C 740 120, 740 140, 740 160" stroke="rgba(122,183,255,0.6)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <!-- SpeciesOverlay -> SpeciesFactory -->
        <path d="M 330 240 C 270 260, 200 300, 150 330" stroke="rgba(255,184,108,0.9)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <!-- SpeciesFactory -> SpeciesResource (conceptual rebuild) -->
        <path d="M 150 260 C 120 190, 80 140, 60 110" stroke="rgba(255,184,108,0.7)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <!-- Food/Plant -> Species (dieta) -->
        <path d="M 640 340 C 520 360, 380 360, 180 380" stroke="rgba(145,215,163,0.8)" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor"/>
          </marker>
        </defs>
      </svg>
    </div>
  </section>

  <section id="modelos" class="panel">
    <h2>Modelos de datos (Godot Resources)</h2>
    <div class="grid cols-2">
      <div class="panel">
        <h3>SpeciesResource (núcleo mínimo)</h3>
        <div class="codeblock">
          <button class="copy-btn" data-copy="#code-species">Copiar</button>
          <pre id="code-species"><code># res://ecosim/data/species/SpeciesResource.gd
extends Resource
class_name SpeciesResource

@export var species_id: String
@export var display_name: String

# Núcleo: stats y hambre
@export var hp_max: float = 10.0
@export var speed: float = 120.0        # px/s
@export var bite_power: float = 2.0     # daño base mordida
@export var stamina_max: float = 100.0

@export var hunger_max: float = 100.0
@export var hunger_rate: float = 1.0    # unidades/s

# Opcionales
@export var diet_tags: Array[String] = []   # ["plant","fruit","meat"]
@export var abilities: Array[Resource] = [] # AbilityResource
@export var tags: Array[String] = []        # ["predator","nocturnal"]
@export var behavior_profile: Resource      # Utility/BT profile</code></pre>
        </div>
        <p class="small">Empieza con esto; todo lo demás puede llegar después sin romper tus especies ya creadas.</p>
      </div>

      <div class="panel">
        <h3>Trait + Ability + Effect</h3>
        <div class="codeblock">
          <button class="copy-btn" data-copy="#code-trait">Copiar Trait</button>
          <pre id="code-trait"><code># res://ecosim/data/traits/TraitResource.gd
extends Resource
class_name TraitResource

@export var add := {"hp_max": 0.0, "speed": 0.0, "bite_power": 0.0, "hunger_rate": 0.0}
@export var mul := {"hp_max": 1.0, "speed": 1.0, "bite_power": 1.0, "hunger_rate": 1.0}
@export var add_diet_tags: Array[String] = []
@export var add_tags: Array[String] = []
@export var add_abilities: Array[Resource] = [] # AbilityResource</code></pre>
        </div>
        <div class="codeblock" style="margin-top:10px;">
          <button class="copy-btn" data-copy="#code-ability">Copiar Ability</button>
          <pre id="code-ability"><code># res://ecosim/data/abilities/AbilityResource.gd
extends Resource
class_name AbilityResource
@export var ability_id: String
@export var tags: Array[String] = []     # "attack","utility"
@export var cooldown_s: float = 5.0
@export var effects: Array[Resource] = [] # EffectResource</code></pre>
        </div>
        <div class="codeblock" style="margin-top:10px;">
          <button class="copy-btn" data-copy="#code-effect">Copiar Effect</button>
          <pre id="code-effect"><code># res://ecosim/data/effects/EffectResource.gd
extends Resource
class_name EffectResource
@export var effect_id: String
@export var type: String # "damage","heal","buff","debuff","state","spawn","push"
@export var params := {"amount": 5.0, "duration_s": 3.0, "stat": "speed", "mult": 0.8}
@export var tags_required: Array[String] = []
@export var tags_blocked: Array[String] = []</code></pre>
        </div>
      </div>

      <div class="panel">
        <h3>SpeciesOverlay + Factory</h3>
        <div class="codeblock">
          <button class="copy-btn" data-copy="#code-overlay">Copiar Overlay</button>
          <pre id="code-overlay"><code># res://ecosim/data/species/SpeciesOverlay.gd
extends Resource
class_name SpeciesOverlay

@export var base_species: Resource            # SpeciesResource
@export var new_species_id: String
@export var display_name_delta: String = ""
@export var set_fields := {}                  # {"hunger_rate": 0.9}
@export var add_fields := {}                  # {"speed": 10}
@export var traits: Array[Resource] = []      # TraitResource</code></pre>
        </div>
        <div class="codeblock" style="margin-top:10px;">
          <button class="copy-btn" data-copy="#code-factory">Copiar Factory</button>
          <pre id="code-factory"><code># res://ecosim/sim/SpeciesFactory.gd
extends Node
class_name SpeciesFactory

func build_from_overlay(overlay: SpeciesOverlay) -> SpeciesResource:
    var base: SpeciesResource = overlay.base_species.duplicate(true)
    base.species_id = overlay.new_species_id
    if overlay.display_name_delta != "":
        base.display_name = overlay.display_name_delta

    for k in overlay.add_fields.keys():
        if base.has_property(k):
            base.set(k, base.get(k) + overlay.add_fields[k])

    for k in overlay.set_fields.keys():
        if base.has_property(k):
            base.set(k, overlay.set_fields[k])

    for t: TraitResource in overlay.traits:
        for k in t.add.keys():
            if base.has_property(k): base.set(k, base.get(k) + t.add[k])
        for k in t.mul.keys():
            if base.has_property(k): base.set(k, base.get(k) * t.mul[k])
        base.diet_tags.append_array(t.add_diet_tags)
        base.tags.append_array(t.add_tags)
        base.abilities.append_array(t.add_abilities)

    base.diet_tags = base.diet_tags.duplicate().uniq()
    base.tags = base.tags.duplicate().uniq()
    return base</code></pre>
        </div>
      </div>

      <div class="panel">
        <h3>Ejemplos mínimos de species/traits</h3>
        <div class="codeblock">
          <button class="copy-btn" data-copy="#code-example">Copiar</button>
          <pre id="code-example"><code># hopper.tres
[resource]
script = ExtResource("res://ecosim/data/species/SpeciesResource.gd")
species_id = "hopper"
display_name = "Hopper"
hp_max = 8.0
speed = 150.0
bite_power = 0.5
stamina_max = 120.0
hunger_max = 100.0
hunger_rate = 1.2

# stalker.tres
[resource]
script = ExtResource("res://ecosim/data/species/SpeciesResource.gd")
species_id = "stalker"
display_name = "Stalker"
hp_max = 12.0
speed = 170.0
bite_power = 3.0
hunger_rate = 1.5
tags = ["predator"]

# runner.tres (Trait)
[resource]
script = ExtResource("res://ecosim/data/traits/TraitResource.gd")
add = {"speed": 30.0}
mul = {"speed": 1.1}

# hopper_forest_overlay.tres
[resource]
script = ExtResource("res://ecosim/data/species/SpeciesOverlay.gd")
base_species = ExtResource("res://ecosim/data/species/hopper.tres")
new_species_id = "hopper_forest"
display_name_delta = "Hopper del Bosque"
add_fields = {"speed": 10.0}
traits = [ExtResource("res://ecosim/data/traits/runner.tres")]</code></pre>
        </div>
      </div>
    </div>
  </section>

  <section id="flujo" class="panel">
    <h2>Flujo de trabajo para 200+ especies</h2>
    <ol class="list">
      <li>Crea 3–5 SpeciesResource base (herbívoro, depredador, carroñero, insectívoro).</li>
      <li>Define Traits atómicos (runner, armored, nocturnal, venomous, carrion_eater).</li>
      <li>Usa SpeciesOverlay para variantes por bioma o evolución (set/add + traits).</li>
      <li>Registra las Species derivadas en un Registry/Spawner por bioma/hábitat.</li>
      <li>Más tarde añade diet_tags y abilities sin tocar especies existentes.</li>
    </ol>
  </section>

  <section id="demo" class="panel">
    <h2>Demo interactiva: derivar una especie (overlay + traits)</h2>
    <p class="small">No es Godot; es una simulación en JS para visualizar cómo se combinan base → overlay → traits.</p>
    <div class="grid cols-2">
      <div class="panel">
        <h3>Entrada</h3>
        <div class="form" id="form">
          <div class="row">
            <div>
              <label>Base species_id</label>
              <input type="text" id="base_id" value="hopper" />
            </div>
            <div>
              <label>display_name</label>
              <input type="text" id="base_name" value="Hopper" />
            </div>
          </div>
          <div class="row-3">
            <div><label>hp_max</label><input type="number" id="hp" value="8" step="0.5" /></div>
            <div><label>speed</label><input type="number" id="speed" value="150" step="5" /></div>
            <div><label>bite_power</label><input type="number" id="bite" value="0.5" step="0.1" /></div>
          </div>
          <div class="row">
            <div><label>hunger_rate</label><input type="number" id="hunger" value="1.2" step="0.1" /></div>
            <div><label>tags (coma)</label><input type="text" id="tags" value="herbivore,diurnal" /></div>
          </div>

          <hr style="border: none; border-top: 1px solid var(--border);" />

          <div class="row">
            <div>
              <label>Overlay new_species_id</label>
              <input type="text" id="new_id" value="hopper_forest" />
            </div>
            <div>
              <label>display_name_delta</label>
              <input type="text" id="new_name" value="Hopper del Bosque" />
            </div>
          </div>
          <div class="row-3">
            <div><label>add.speed</label><input type="number" id="add_speed" value="10" step="1" /></div>
            <div><label>set.hunger_rate</label><input type="number" id="set_hunger" value="1.1" step="0.1" /></div>
            <div><label>add.hp_max</label><input type="number" id="add_hp" value="0" step="0.5" /></div>
          </div>

          <label>Traits</label>
          <div class="checkboxes">
            <label class="toggle"><input type="checkbox" id="t_runner" /> runner (+30 speed, x1.1 speed)</label>
            <label class="toggle"><input type="checkbox" id="t_venom" /> venomous (x1.2 bite, +tag venomous)</label>
            <label class="toggle"><input type="checkbox" id="t_carrion" /> carrion_eater (+diet carrion, +tag scavenger)</label>
          </div>

          <button class="btn" id="build">Construir especie derivada</button>
        </div>
      </div>

      <div class="panel">
        <h3>Salida combinada</h3>
        <div class="out" id="out"></div>
        <p class="small">Equivale a duplicar la base, aplicar add/set del overlay y luego sumar/multiplicar traits, unificar tags/diet.</p>
      </div>
    </div>
  </section>

  <section id="componentes" class="panel">
    <h2>Componentes del agente y AI</h2>
    <div class="grid cols-2">
      <div class="panel">
        <h3>Componentes</h3>
        <ul class="list">
          <li><span class="pill">Stats</span> valores actuales + modificadores.</li>
          <li><span class="pill">Needs</span> hambre/sed/energía.</li>
          <li><span class="pill">Metabolism</span> consumo de nutrientes y desgaste.</li>
          <li><span class="pill">Perception</span> visión/olfato/sonido con particionado espacial.</li>
          <li><span class="pill">Locomotion</span> steering y colisiones.</li>
          <li><span class="pill">Behavior</span> Utility AI con prioridades.</li>
          <li><span class="pill">Interaction</span> comer, atacar, huir, aparearse.</li>
          <li><span class="pill">Ability</span> cooldowns y efectos.</li>
        </ul>
      </div>
      <div class="panel">
        <h3>Ejemplo de Agente (Godot)</h3>
        <div class="codeblock">
          <button class="copy-btn" data-copy="#code-agent">Copiar</button>
          <pre id="code-agent"><code># res://ecosim/sim/Agent.gd
extends CharacterBody2D
@export var species: SpeciesResource

var hp: float
var hunger: float

func _ready():
    hp = species.hp_max
    hunger = 0.0

func _physics_process(delta):
    # hambre
    hunger = clampf(hunger + species.hunger_rate * delta, 0.0, species.hunger_max)

    # movimiento: reemplaza desired_direction() por tu lógica/AI
    var dir := desired_direction()
    velocity = dir * species.speed
    move_and_slide()

func desired_direction() -> Vector2:
    # placeholder; aquí entra tu Behavior/Perception
    return Vector2.RIGHT.rotated(Time.get_ticks_msec() * 0.0005)</code></pre>
        </div>
      </div>
    </div>
  </section>

  <section id="proyecto" class="panel">
    <h2>Estructura de proyecto (sugerida)</h2>
    <div class="grid cols-2">
      <div class="panel">
        <h3>Árbol de carpetas</h3>
        <pre><code>res://ecosim/
  core/
    EcosystemManager.gd
    Registry.gd
    TickScheduler.gd
    SpatialPartition.gd
  data/
    species/ (SpeciesResource.gd, SpeciesOverlay.gd, *.tres)
    traits/  (TraitResource.gd, *.tres)
    abilities/ (AbilityResource.gd, *.tres)
    effects/ (EffectResource.gd, *.tres)
    foods/ plants/ biomes/ (opcionales)
  sim/
    components/ ai/ interactions/ effects/
    SpeciesFactory.gd
    Agent.tscn, Plant.tscn
  spawn/
    SpawnTableResource.gd
    Spawner.gd</code></pre>
      </div>
      <div class="panel">
        <h3>Checklist de escalabilidad</h3>
        <ul class="list">
          <li>IDs únicos y validador de duplicados en Registry.</li>
          <li>Defaults seguros en Resources (no nulls peligrosos).</li>
          <li>LOD de AI: ticks más lentos fuera de cámara.</li>
          <li>Particionado espacial (grid/quadtree) para percepción.</li>
          <li>Pooling de agentes y objetos consumibles.</li>
          <li>Separar modelo lógico del render para entidades lejanas.</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="rendimiento" class="panel">
    <h2>Notas rápidas de rendimiento</h2>
    <ul class="list">
      <li>Batching por sistemas: procesa arrays de componentes en loops tight.</li>
      <li>Evita señales por entidad en rutas hot; usa colas/sistemas.</li>
      <li>Reduce checks de percepción con celdas (vecinos por chunk).</li>
      <li>Usa timers/coalescing: AI cada 0.5–2s; movimiento cada frame.</li>
      <li>Serializa estado mínimo (id, pos, stats, edad, efectos) para guardar/cargar.</li>
    </ul>
  </section>

</main>

<footer>
  Hecho con cariño para aclarar la estructura y que crear 200+ especies sea cosa de minutos. Expande sin miedo.
</footer>

<script>
  // Copy to clipboard for code blocks
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.copy);
      if (!target) return;
      const text = target.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const prev = btn.textContent;
        btn.textContent = 'Copiado ✓';
        setTimeout(() => btn.textContent = prev, 1000);
      });
    });
  });

  // Demo: overlay + traits builder
  const out = document.getElementById('out');
  const traitsLib = {
    runner: {
      add: { speed: 30 },
      mul: { speed: 1.1 },
      add_tags: [],
      add_diet: [],
      hint: 'runner (+30 speed, x1.1 speed)'
    },
    venomous: {
      add: {},
      mul: { bite_power: 1.2 },
      add_tags: ['venomous'],
      add_diet: [],
      hint: 'venomous (x1.2 bite, +tag venomous)'
    },
    carrion: {
      add: {},
      mul: {},
      add_tags: ['scavenger'],
      add_diet: ['carrion'],
      hint: 'carrion_eater (+diet carrion, +tag scavenger)'
    }
  };

  function parseTags(s) {
    return s.split(',').map(x => x.trim()).filter(Boolean);
  }

  function uniq(arr) { return Array.from(new Set(arr)); }

  function build() {
    // Base
    const base = {
      species_id: document.getElementById('base_id').value || 'base',
      display_name: document.getElementById('base_name').value || 'Base',
      hp_max: parseFloat(document.getElementById('hp').value || '10'),
      speed: parseFloat(document.getElementById('speed').value || '120'),
      bite_power: parseFloat(document.getElementById('bite').value || '2'),
      stamina_max: 100,
      hunger_max: 100,
      hunger_rate: parseFloat(document.getElementById('hunger').value || '1'),
      diet_tags: [],
      abilities: [],
      tags: parseTags(document.getElementById('tags').value || '')
    };

    // Overlay deltas
    const overlay = {
      new_id: document.getElementById('new_id').value || (base.species_id + '_var'),
      new_name: document.getElementById('new_name').value || base.display_name + ' Var',
      add: {
        speed: parseFloat(document.getElementById('add_speed').value || '0'),
        hp_max: parseFloat(document.getElementById('add_hp').value || '0')
      },
      set: {
        hunger_rate: parseFloat(document.getElementById('set_hunger').value || base.hunger_rate)
      },
      traits: []
    };

    if (document.getElementById('t_runner').checked) overlay.traits.push('runner');
    if (document.getElementById('t_venom').checked) overlay.traits.push('venomous');
    if (document.getElementById('t_carrion').checked) overlay.traits.push('carrion');

    // Build: duplicate base
    const outSpec = JSON.parse(JSON.stringify(base));
    outSpec.species_id = overlay.new_id;
    outSpec.display_name = overlay.new_name;

    // Apply add
    for (const k of Object.keys(overlay.add)) {
      if (typeof outSpec[k] === 'number') outSpec[k] += overlay.add[k];
    }
    // Apply set
    for (const k of Object.keys(overlay.set)) {
      if (k in outSpec) outSpec[k] = overlay.set[k];
    }
    // Apply traits
    const appliedTraits = [];
    for (const t of overlay.traits) {
      const tr = traitsLib[t];
      if (!tr) continue;
      appliedTraits.push(tr.hint);
      for (const k of Object.keys(tr.add)) {
        if (typeof outSpec[k] === 'number') outSpec[k] += tr.add[k];
      }
      for (const k of Object.keys(tr.mul)) {
        if (typeof outSpec[k] === 'number') outSpec[k] *= tr.mul[k];
      }
      outSpec.tags = uniq(outSpec.tags.concat(tr.add_tags));
      outSpec.diet_tags = uniq(outSpec.diet_tags.concat(tr.add_diet));
    }

    // Round some numbers for display
    outSpec.speed = Math.round(outSpec.speed * 100) / 100;
    outSpec.bite_power = Math.round(outSpec.bite_power * 100) / 100;
    outSpec.hunger_rate = Math.round(outSpec.hunger_rate * 1000) / 1000;

    // Print
    const preview = {
      species_id: outSpec.species_id,
      display_name: outSpec.display_name,
      stats: {
        hp_max: outSpec.hp_max,
        speed: outSpec.speed,
        bite_power: outSpec.bite_power,
        hunger_rate: outSpec.hunger_rate
      },
      tags: outSpec.tags,
      diet_tags: outSpec.diet_tags,
      traits_applied: appliedTraits
    };
    out.textContent = JSON.stringify(preview, null, 2);
  }
  document.getElementById('build').addEventListener('click', build);
  // First run
  build();
</script>
</body>
</html>
